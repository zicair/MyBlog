---
title: ConcurrentHashMap&Hashtable
tags:
  - è½¬è½½
  - ConcurrentHashMap
  - Hashtable
categories:
  - Java
date: 2020-09-01 02:15:32
---

äº†è§£ConcurrentHashMapå’ŒHashtableçš„ä¸€äº›å¼‚åŒï¼Œæºç ã€ä»¥åŠæ‹“å±•ç‚¹ã€‚

<!--more-->

è½¬è½½ï¼š[https://crossoverjie.top/2018/07/23/java-senior/ConcurrentHashMap/](https://crossoverjie.top/2018/07/23/java-senior/ConcurrentHashMap/)

è½¬è½½ï¼š[https://juejin.im/post/6844904023003250701](https://juejin.im/post/6844904023003250701)

# HashMap

ä¼—æ‰€å‘¨çŸ¥ HashMap åº•å±‚æ˜¯åŸºäº `æ•°ç»„ + é“¾è¡¨` ç»„æˆçš„ï¼Œä¸è¿‡åœ¨ jdk1.7 å’Œ 1.8 ä¸­å…·ä½“å®ç°ç¨æœ‰ä¸åŒã€‚

## Base 1.7

1.7 ä¸­çš„æ•°æ®ç»“æ„å›¾ï¼š

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/5cd1d2be77958.jpg)



å…ˆæ¥çœ‹çœ‹ 1.7 ä¸­çš„å®ç°ã€‚

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/5cd1d2bfd6aba.jpg)

è¿™æ˜¯ HashMap ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„å‡ ä¸ªæˆå‘˜å˜é‡ï¼›çœ‹çœ‹åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

1. åˆå§‹åŒ–æ¡¶å¤§å°ï¼Œå› ä¸ºåº•å±‚æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥è¿™æ˜¯æ•°ç»„é»˜è®¤çš„å¤§å°ã€‚
2. æ¡¶æœ€å¤§å€¼ã€‚
3. é»˜è®¤çš„è´Ÿè½½å› å­ï¼ˆ0.75ï¼‰
4. `table` çœŸæ­£å­˜æ”¾æ•°æ®çš„æ•°ç»„ã€‚
5. `Map` å­˜æ”¾æ•°é‡çš„å¤§å°ã€‚
6. æ¡¶å¤§å°ï¼Œå¯åœ¨åˆå§‹åŒ–æ—¶æ˜¾å¼æŒ‡å®šã€‚
7. è´Ÿè½½å› å­ï¼Œå¯åœ¨åˆå§‹åŒ–æ—¶æ˜¾å¼æŒ‡å®šã€‚

é‡ç‚¹è§£é‡Šä¸‹è´Ÿè½½å› å­ï¼š

ç”±äºç»™å®šçš„ HashMap çš„å®¹é‡å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚é»˜è®¤åˆå§‹åŒ–ï¼š

```java
public HashMap() {
    this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR);
}

public HashMap(int initialCapacity, float loadFactor) {
    if (initialCapacity < 0)
        throw new IllegalArgumentException("Illegal initial capacity: " +
                                           initialCapacity);
    if (initialCapacity > MAXIMUM_CAPACITY)
        initialCapacity = MAXIMUM_CAPACITY;
    if (loadFactor <= 0 || Float.isNaN(loadFactor))
        throw new IllegalArgumentException("Illegal load factor: " +
                                           loadFactor);

    this.loadFactor = loadFactor;
    threshold = initialCapacity;
    init();
}
```

ç»™å®šçš„é»˜è®¤å®¹é‡ä¸º 16ï¼Œè´Ÿè½½å› å­ä¸º 0.75ã€‚Map åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸æ–­çš„å¾€é‡Œé¢å­˜æ”¾æ•°æ®ï¼Œå½“æ•°é‡è¾¾åˆ°äº† `16 * 0.75 = 12` å°±éœ€è¦å°†å½“å‰ 16 çš„å®¹é‡è¿›è¡Œæ‰©å®¹ï¼Œè€Œæ‰©å®¹è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ° rehashã€å¤åˆ¶æ•°æ®ç­‰æ“ä½œï¼Œæ‰€ä»¥éå¸¸æ¶ˆè€—æ€§èƒ½ã€‚

å› æ­¤é€šå¸¸å»ºè®®èƒ½æå‰é¢„ä¼° HashMap çš„å¤§å°æœ€å¥½ï¼Œå°½é‡çš„å‡å°‘æ‰©å®¹å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚

æ ¹æ®ä»£ç å¯ä»¥çœ‹åˆ°å…¶å®çœŸæ­£å­˜æ”¾æ•°æ®çš„æ˜¯

```
transient Entry<K,V>[] table = (Entry<K,V>[]) EMPTY_TABLE;
```

è¿™ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆå®ƒåˆæ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢ï¼Ÿ

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/5cd1d2c08e693.jpg)

Entry æ˜¯ HashMap ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä»ä»–çš„æˆå‘˜å˜é‡å¾ˆå®¹æ˜“çœ‹å‡ºï¼š

- key å°±æ˜¯å†™å…¥æ—¶çš„é”®ã€‚
- value è‡ªç„¶å°±æ˜¯å€¼ã€‚
- å¼€å§‹çš„æ—¶å€™å°±æåˆ° HashMap æ˜¯ç”±æ•°ç»„å’Œé“¾è¡¨ç»„æˆï¼Œæ‰€ä»¥è¿™ä¸ª next å°±æ˜¯ç”¨äºå®ç°é“¾è¡¨ç»“æ„ã€‚
- hash å­˜æ”¾çš„æ˜¯å½“å‰ key çš„ hashcodeã€‚

çŸ¥æ™“äº†åŸºæœ¬ç»“æ„ï¼Œé‚£æ¥çœ‹çœ‹å…¶ä¸­é‡è¦çš„å†™å…¥ã€è·å–å‡½æ•°ï¼š

### put æ–¹æ³•

```java
public V put(K key, V value) {
    if (table == EMPTY_TABLE) {
        inflateTable(threshold);
    }
    if (key == null)
        return putForNullKey(value);
    int hash = hash(key);
    int i = indexFor(hash, table.length);
    for (Entry<K,V> e = table[i]; e != null; e = e.next) {
        Object k;
        if (e.hash == hash && ((k = e.key) == key || key.equals(k))) {
            V oldValue = e.value;
            e.value = value;
            e.recordAccess(this);
            return oldValue;
        }
    }

    modCount++;
    addEntry(hash, key, value, i);
    return null;
}
```

- åˆ¤æ–­å½“å‰æ•°ç»„æ˜¯å¦éœ€è¦åˆå§‹åŒ–ã€‚
- å¦‚æœ key ä¸ºç©ºï¼Œåˆ™ put ä¸€ä¸ªç©ºå€¼è¿›å»ã€‚
- æ ¹æ® key è®¡ç®—å‡º hashcodeã€‚
- æ ¹æ®è®¡ç®—å‡ºçš„ hashcode å®šä½å‡ºæ‰€åœ¨æ¡¶ã€‚
- å¦‚æœæ¡¶æ˜¯ä¸€ä¸ªé“¾è¡¨åˆ™éœ€è¦éå†åˆ¤æ–­é‡Œé¢çš„ hashcodeã€key æ˜¯å¦å’Œä¼ å…¥ key ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™è¿›è¡Œè¦†ç›–ï¼Œå¹¶è¿”å›åŸæ¥çš„å€¼ã€‚
- å¦‚æœæ¡¶æ˜¯ç©ºçš„ï¼Œè¯´æ˜å½“å‰ä½ç½®æ²¡æœ‰æ•°æ®å­˜å…¥ï¼›æ–°å¢ä¸€ä¸ª Entry å¯¹è±¡å†™å…¥å½“å‰ä½ç½®ã€‚

```java
void addEntry(int hash, K key, V value, int bucketIndex) {
    if ((size >= threshold) && (null != table[bucketIndex])) {
        resize(2 * table.length);
        hash = (null != key) ? hash(key) : 0;
        bucketIndex = indexFor(hash, table.length);
    }

    createEntry(hash, key, value, bucketIndex);
}

void createEntry(int hash, K key, V value, int bucketIndex) {
    Entry<K,V> e = table[bucketIndex];
    table[bucketIndex] = new Entry<>(hash, key, value, e);
    size++;
}
```

å½“è°ƒç”¨ addEntry å†™å…¥ Entry æ—¶éœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚

å¦‚æœéœ€è¦å°±è¿›è¡Œä¸¤å€æ‰©å……ï¼Œå¹¶å°†å½“å‰çš„ key é‡æ–° hash å¹¶å®šä½ã€‚

è€Œåœ¨ `createEntry` ä¸­ä¼šå°†å½“å‰ä½ç½®çš„æ¡¶ä¼ å…¥åˆ°æ–°å»ºçš„æ¡¶ä¸­ï¼Œå¦‚æœå½“å‰æ¡¶æœ‰å€¼å°±ä¼šåœ¨ä½ç½®å½¢æˆé“¾è¡¨ã€‚

### get æ–¹æ³•

å†æ¥çœ‹çœ‹ get å‡½æ•°ï¼š

```java
public V get(Object key) {
    if (key == null)
        return getForNullKey();
    Entry<K,V> entry = getEntry(key);

    return null == entry ? null : entry.getValue();
}

final Entry<K,V> getEntry(Object key) {
    if (size == 0) {
        return null;
    }

    int hash = (key == null) ? 0 : hash(key);
    for (Entry<K,V> e = table[indexFor(hash, table.length)];
         e != null;
         e = e.next) {
        Object k;
        if (e.hash == hash &&
            ((k = e.key) == key || (key != null && key.equals(k))))
            return e;
    }
    return null;
}
```

- é¦–å…ˆä¹Ÿæ˜¯æ ¹æ® key è®¡ç®—å‡º hashcodeï¼Œç„¶åå®šä½åˆ°å…·ä½“çš„æ¡¶ä¸­ã€‚
- åˆ¤æ–­è¯¥ä½ç½®æ˜¯å¦ä¸ºé“¾è¡¨ã€‚
- ä¸æ˜¯é“¾è¡¨å°±æ ¹æ® `keyã€key çš„ hashcode` æ˜¯å¦ç›¸ç­‰æ¥è¿”å›å€¼ã€‚
- ä¸ºé“¾è¡¨åˆ™éœ€è¦éå†ç›´åˆ° key åŠ hashcode ç›¸ç­‰æ—¶å€™å°±è¿”å›å€¼ã€‚
- å•¥éƒ½æ²¡å–åˆ°å°±ç›´æ¥è¿”å› null ã€‚

## Base 1.8

ä¸çŸ¥é“ 1.7 çš„å®ç°å¤§å®¶çœ‹å‡ºéœ€è¦ä¼˜åŒ–çš„ç‚¹æ²¡æœ‰ï¼Ÿ

å…¶å®ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„åœ°æ–¹å°±æ˜¯ï¼š

> å½“ Hash å†²çªä¸¥é‡æ—¶ï¼Œåœ¨æ¡¶ä¸Šå½¢æˆçš„é“¾è¡¨ä¼šå˜çš„è¶Šæ¥è¶Šé•¿ï¼Œè¿™æ ·åœ¨æŸ¥è¯¢æ—¶çš„æ•ˆç‡å°±ä¼šè¶Šæ¥è¶Šä½ï¼›æ—¶é—´å¤æ‚åº¦ä¸º `O(N)`ã€‚

å› æ­¤ 1.8 ä¸­é‡ç‚¹ä¼˜åŒ–äº†è¿™ä¸ªæŸ¥è¯¢æ•ˆç‡ã€‚

1.8 HashMap ç»“æ„å›¾ï¼š

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/5cd1d2c1c1cd7.jpg)

å…ˆæ¥çœ‹çœ‹å‡ ä¸ªæ ¸å¿ƒçš„æˆå‘˜å˜é‡ï¼š

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16

/**
 * The maximum capacity, used if a higher value is implicitly specified
 * by either of the constructors with arguments.
 * MUST be a power of two <= 1<<30.
 */
static final int MAXIMUM_CAPACITY = 1 << 30;

/**
 * The load factor used when none specified in constructor.
 */
static final float DEFAULT_LOAD_FACTOR = 0.75f;

static final int TREEIFY_THRESHOLD = 8;

transient Node<K,V>[] table;

/**
 * Holds cached entrySet(). Note that AbstractMap fields are used
 * for keySet() and values().
 */
transient Set<Map.Entry<K,V>> entrySet;

/**
 * The number of key-value mappings contained in this map.
 */
transient int size;
```

å’Œ 1.7 å¤§ä½“ä¸Šéƒ½å·®ä¸å¤šï¼Œè¿˜æ˜¯æœ‰å‡ ä¸ªé‡è¦çš„åŒºåˆ«ï¼š

- `TREEIFY_THRESHOLD` ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼ã€‚
- HashEntry ä¿®æ”¹ä¸º Nodeã€‚

Node çš„æ ¸å¿ƒç»„æˆå…¶å®ä¹Ÿæ˜¯å’Œ 1.7 ä¸­çš„ HashEntry ä¸€æ ·ï¼Œå­˜æ”¾çš„éƒ½æ˜¯ `key value hashcode next` ç­‰æ•°æ®ã€‚

å†æ¥çœ‹çœ‹æ ¸å¿ƒæ–¹æ³•ã€‚

### put æ–¹æ³•

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/5cd1d2c378090.jpg)

çœ‹ä¼¼è¦æ¯” 1.7 çš„å¤æ‚ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£ï¼š

1. åˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦ä¸ºç©ºï¼Œç©ºçš„å°±éœ€è¦åˆå§‹åŒ–ï¼ˆresize ä¸­ä¼šåˆ¤æ–­æ˜¯å¦è¿›è¡Œåˆå§‹åŒ–ï¼‰ã€‚
2. æ ¹æ®å½“å‰ key çš„ hashcode å®šä½åˆ°å…·ä½“çš„æ¡¶ä¸­å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨æ˜æ²¡æœ‰ Hash å†²çªå°±ç›´æ¥åœ¨å½“å‰ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°æ¡¶å³å¯ã€‚
3. å¦‚æœå½“å‰æ¡¶æœ‰å€¼ï¼ˆ Hash å†²çªï¼‰ï¼Œé‚£ä¹ˆå°±è¦æ¯”è¾ƒå½“å‰æ¡¶ä¸­çš„ `keyã€key çš„ hashcode` ä¸å†™å…¥çš„ key æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰å°±èµ‹å€¼ç»™ `e`,åœ¨ç¬¬ 8 æ­¥çš„æ—¶å€™ä¼šç»Ÿä¸€è¿›è¡Œèµ‹å€¼åŠè¿”å›ã€‚
4. å¦‚æœå½“å‰æ¡¶ä¸ºçº¢é»‘æ ‘ï¼Œé‚£å°±è¦æŒ‰ç…§çº¢é»‘æ ‘çš„æ–¹å¼å†™å…¥æ•°æ®ã€‚
5. å¦‚æœæ˜¯ä¸ªé“¾è¡¨ï¼Œå°±éœ€è¦å°†å½“å‰çš„ keyã€value å°è£…æˆä¸€ä¸ªæ–°èŠ‚ç‚¹å†™å…¥åˆ°å½“å‰æ¡¶çš„åé¢ï¼ˆå½¢æˆé“¾è¡¨ï¼‰ã€‚
6. æ¥ç€åˆ¤æ–­å½“å‰é“¾è¡¨çš„å¤§å°æ˜¯å¦å¤§äºé¢„è®¾çš„é˜ˆå€¼ï¼Œå¤§äºæ—¶å°±è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚
7. å¦‚æœåœ¨éå†è¿‡ç¨‹ä¸­æ‰¾åˆ° key ç›¸åŒæ—¶ç›´æ¥é€€å‡ºéå†ã€‚
8. å¦‚æœ `e != null` å°±ç›¸å½“äºå­˜åœ¨ç›¸åŒçš„ key,é‚£å°±éœ€è¦å°†å€¼è¦†ç›–ã€‚
9. æœ€ååˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚

### get æ–¹æ³•

```java
public V get(Object key) {
    Node<K,V> e;
    return (e = getNode(hash(key), key)) == null ? null : e.value;
}

final Node<K,V> getNode(int hash, Object key) {
    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;
    if ((tab = table) != null && (n = tab.length) > 0 &&
        (first = tab[(n - 1) & hash]) != null) {
        if (first.hash == hash && // always check first node
            ((k = first.key) == key || (key != null && key.equals(k))))
            return first;
        if ((e = first.next) != null) {
            if (first instanceof TreeNode)
                return ((TreeNode<K,V>)first).getTreeNode(hash, key);
            do {
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    return e;
            } while ((e = e.next) != null);
        }
    }
    return null;
}
```

get æ–¹æ³•çœ‹èµ·æ¥å°±è¦ç®€å•è®¸å¤šäº†ã€‚

- é¦–å…ˆå°† key hash ä¹‹åå–å¾—æ‰€å®šä½çš„æ¡¶ã€‚
- å¦‚æœæ¡¶ä¸ºç©ºåˆ™ç›´æ¥è¿”å› null ã€‚
- å¦åˆ™åˆ¤æ–­æ¡¶çš„ç¬¬ä¸€ä¸ªä½ç½®(æœ‰å¯èƒ½æ˜¯é“¾è¡¨ã€çº¢é»‘æ ‘)çš„ key æ˜¯å¦ä¸ºæŸ¥è¯¢çš„ keyï¼Œæ˜¯å°±ç›´æ¥è¿”å› valueã€‚
- å¦‚æœç¬¬ä¸€ä¸ªä¸åŒ¹é…ï¼Œåˆ™åˆ¤æ–­å®ƒçš„ä¸‹ä¸€ä¸ªæ˜¯çº¢é»‘æ ‘è¿˜æ˜¯é“¾è¡¨ã€‚
- çº¢é»‘æ ‘å°±æŒ‰ç…§æ ‘çš„æŸ¥æ‰¾æ–¹å¼è¿”å›å€¼ã€‚
- ä¸ç„¶å°±æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼éå†åŒ¹é…è¿”å›å€¼ã€‚

ä»è¿™ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼ˆget/putï¼‰å¯ä»¥çœ‹å‡º 1.8 ä¸­å¯¹å¤§é“¾è¡¨åšäº†ä¼˜åŒ–ï¼Œä¿®æ”¹ä¸ºçº¢é»‘æ ‘ä¹‹åæŸ¥è¯¢æ•ˆç‡ç›´æ¥æé«˜åˆ°äº† `O(logn)`ã€‚

ä½†æ˜¯ HashMap åŸæœ‰çš„é—®é¢˜ä¹Ÿéƒ½å­˜åœ¨ï¼Œæ¯”å¦‚åœ¨å¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨æ—¶å®¹æ˜“å‡ºç°æ­»å¾ªç¯ã€‚

```java
final HashMap<String, String> map = new HashMap<String, String>();
for (int i = 0; i < 1000; i++) {
    new Thread(new Runnable() {
        @Override
        public void run() {
            map.put(UUID.randomUUID().toString(), "");
        }
    }).start();
}
```

ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç®€å•åˆ†æä¸‹ã€‚

çœ‹è¿‡ä¸Šæ–‡çš„è¿˜è®°å¾—åœ¨ HashMap æ‰©å®¹çš„æ—¶å€™ä¼šè°ƒç”¨ `resize()` æ–¹æ³•ï¼Œå°±æ˜¯è¿™é‡Œçš„å¹¶å‘æ“ä½œå®¹æ˜“åœ¨ä¸€ä¸ªæ¡¶ä¸Šå½¢æˆç¯å½¢é“¾è¡¨ï¼›è¿™æ ·å½“è·å–ä¸€ä¸ªä¸å­˜åœ¨çš„ key æ—¶ï¼Œè®¡ç®—å‡ºçš„ index æ­£å¥½æ˜¯ç¯å½¢é“¾è¡¨çš„ä¸‹æ ‡å°±ä¼šå‡ºç°æ­»å¾ªç¯ã€‚

# HashMap&Hashtable

> Hashmapä¸­çš„é“¾è¡¨å¤§å°è¶…è¿‡å…«ä¸ªæ—¶ä¼šè‡ªåŠ¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œå½“åˆ é™¤å°äºå…­æ—¶é‡æ–°å˜ä¸ºé“¾è¡¨ï¼Œä¸ºå•¥å‘¢ï¼Ÿ

æ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼Œåœ¨è´Ÿè½½å› å­é»˜è®¤ä¸º0.75çš„æ—¶å€™ï¼Œå•ä¸ªhashæ§½å†…å…ƒç´ ä¸ªæ•°ä¸º8çš„æ¦‚ç‡å°äºç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œæ‰€ä»¥å°†7ä½œä¸ºä¸€ä¸ªåˆ†æ°´å²­ï¼Œç­‰äº7çš„æ—¶å€™ä¸è½¬æ¢ï¼Œå¤§äºç­‰äº8çš„æ—¶å€™æ‰è¿›è¡Œè½¬æ¢ï¼Œå°äºç­‰äº6çš„æ—¶å€™å°±åŒ–ä¸ºé“¾è¡¨ã€‚



> HashMapåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚£ä½ ä¸€èˆ¬éƒ½æ˜¯æ€ä¹ˆå¤„ç†è¿™ç§æƒ…å†µçš„ï¼Ÿ

- ä½¿ç”¨Collections.synchronizedMap(Map)åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„mapé›†åˆï¼›
- Hashtable
- ConcurrentHashMap

ä¸è¿‡å‡ºäºçº¿ç¨‹å¹¶å‘åº¦çš„åŸå› ï¼Œæˆ‘éƒ½ä¼šèˆå¼ƒå‰ä¸¤è€…ä½¿ç”¨æœ€åçš„ConcurrentHashMapï¼Œä»–çš„æ€§èƒ½å’Œæ•ˆç‡æ˜æ˜¾é«˜äºå‰ä¸¤è€…ã€‚

> å“¦ï¼ŒCollections.synchronizedMapæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„ä½ æœ‰äº†è§£è¿‡ä¹ˆï¼Ÿ

åœ¨SynchronizedMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡Mapï¼Œè¿˜æœ‰æ’æ–¥é”mutexï¼Œå¦‚å›¾

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f14087ded252dc)

```java
Collections.synchronizedMap(new HashMap<>(16));
```

æˆ‘ä»¬åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å°±éœ€è¦ä¼ å…¥ä¸€ä¸ªMapï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå¦‚æœä½ ä¼ å…¥äº†mutexå‚æ•°ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºä¼ å…¥çš„å¯¹è±¡ã€‚

å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºthisï¼Œå³è°ƒç”¨synchronizedMapçš„å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šé¢çš„Mapã€‚

åˆ›å»ºå‡ºsynchronizedMapä¹‹åï¼Œå†æ“ä½œmapçš„æ—¶å€™ï¼Œå°±ä¼šå¯¹æ–¹æ³•ä¸Šé”ï¼Œå¦‚å›¾å…¨æ˜¯ğŸ”

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f14087dffc8e69)

> å›ç­”å¾—ä¸é”™ï¼Œèƒ½è·Ÿæˆ‘èŠä¸€ä¸‹Hashtableä¹ˆï¼Ÿ

è·ŸHashMapç›¸æ¯”Hashtableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€‚åˆåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯æ•ˆç‡å¯ä¸å¤ªä¹è§‚ã€‚

> å“¦ï¼Œä½ èƒ½è¯´è¯´ä»–æ•ˆç‡ä½çš„åŸå› ä¹ˆï¼Ÿ

å—¯å—¯é¢è¯•å®˜ï¼Œæˆ‘çœ‹è¿‡ä»–çš„æºç ï¼Œä»–åœ¨å¯¹æ•°æ®æ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œæ‰€ä»¥æ•ˆç‡æ¯”è¾ƒä½ä¸‹ã€‚

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f14087e8fcfc64)

> é™¤äº†è¿™ä¸ªä½ è¿˜èƒ½è¯´å‡ºä¸€äº›Hashtable è·ŸHashMapä¸ä¸€æ ·ç‚¹ä¹ˆï¼Ÿ

Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼åˆ™éƒ½å¯ä»¥ä¸º nullã€‚

> å‘ƒæˆ‘èƒ½æ‰“æ–­ä½ ä¸€ä¸‹ä¹ˆï¼Ÿä¸ºå•¥ Hashtable æ˜¯ä¸å…è®¸ KEY å’Œ VALUE ä¸º null, è€Œ HashMap åˆ™å¯ä»¥å‘¢ï¼Ÿ

å› ä¸ºHashtableåœ¨æˆ‘ä»¬put ç©ºå€¼çš„æ—¶å€™ä¼šç›´æ¥æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä½†æ˜¯HashMapå´åšäº†ç‰¹æ®Šå¤„ç†ã€‚

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

> ä½†æ˜¯ä½ è¿˜æ˜¯æ²¡è¯´ä¸ºå•¥Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼åˆ™éƒ½å¯ä»¥ä¸º nullï¼Ÿ

è¿™æ˜¯å› ä¸ºHashtableä½¿ç”¨çš„æ˜¯**å®‰å…¨å¤±è´¥æœºåˆ¶ï¼ˆfail-safeï¼‰**ï¼Œè¿™ç§æœºåˆ¶ä¼šä½¿ä½ æ­¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®ã€‚

å¦‚æœä½ ä½¿ç”¨nullå€¼ï¼Œå°±ä¼šä½¿å¾—å…¶æ— æ³•åˆ¤æ–­å¯¹åº”çš„keyæ˜¯ä¸å­˜åœ¨è¿˜æ˜¯ä¸ºç©ºï¼Œå› ä¸ºä½ æ— æ³•å†è°ƒç”¨ä¸€æ¬¡contain(keyï¼‰æ¥å¯¹keyæ˜¯å¦å­˜åœ¨è¿›è¡Œåˆ¤æ–­ï¼ŒConcurrentHashMapåŒç†ã€‚

> å¥½çš„ä½ ç»§ç»­è¯´ä¸åŒç‚¹å§ã€‚

- **å®ç°æ–¹å¼ä¸åŒ**ï¼šHashtable ç»§æ‰¿äº† Dictionaryç±»ï¼Œè€Œ HashMap ç»§æ‰¿çš„æ˜¯ AbstractMap ç±»ã€‚

  Dictionary æ˜¯ JDK 1.0 æ·»åŠ çš„ï¼Œè²Œä¼¼æ²¡äººç”¨è¿‡è¿™ä¸ªï¼Œæˆ‘ä¹Ÿæ²¡ç”¨è¿‡ã€‚

- **åˆå§‹åŒ–å®¹é‡ä¸åŒ**ï¼šHashMap çš„åˆå§‹å®¹é‡ä¸ºï¼š16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸ºï¼š11ï¼Œä¸¤è€…çš„è´Ÿè½½å› å­é»˜è®¤éƒ½æ˜¯ï¼š0.75ã€‚

- **æ‰©å®¹æœºåˆ¶ä¸åŒ**ï¼šå½“ç°æœ‰å®¹é‡å¤§äºæ€»å®¹é‡ * è´Ÿè½½å› å­æ—¶ï¼ŒHashMap æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ï¼ŒHashtable æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ + 1ã€‚

- **è¿­ä»£å™¨ä¸åŒ**ï¼šHashMap ä¸­çš„ Iterator è¿­ä»£å™¨æ˜¯ fail-fast çš„ï¼Œè€Œ Hashtable çš„ Enumerator ä¸æ˜¯ fail-fast çš„ã€‚

  æ‰€ä»¥ï¼Œå½“å…¶ä»–çº¿ç¨‹æ”¹å˜äº†HashMap çš„ç»“æ„ï¼Œå¦‚ï¼šå¢åŠ ã€åˆ é™¤å…ƒç´ ï¼Œå°†ä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸ï¼Œè€Œ Hashtable åˆ™ä¸ä¼šã€‚

> fail-fastæ˜¯å•¥ï¼Ÿ

**å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰**æ˜¯javaé›†åˆä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œ åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡ºConcurrent Modification Exceptionã€‚

> ä»–çš„åŸç†æ˜¯å•¥ï¼Ÿ

è¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª modCount å˜é‡ã€‚

é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜modCountçš„å€¼ã€‚

æ¯å½“è¿­ä»£å™¨ä½¿ç”¨hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹modCountå˜é‡æ˜¯å¦ä¸ºexpectedmodCountå€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚

**Tip**ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹modCountå€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº†expectedmodCountå€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚

å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„bugã€‚

> è¯´è¯´ä»–çš„åœºæ™¯ï¼Ÿ

java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼ˆè¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼‰ç®—æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶å§ã€‚ 

**Tip**ï¼š**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**å¤§å®¶ä¹Ÿå¯ä»¥äº†è§£ä¸‹ï¼Œjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚

> éƒ½è¯´äº†ä»–çš„å¹¶å‘åº¦ä¸å¤Ÿï¼Œæ€§èƒ½å¾ˆä½ï¼Œè¿™ä¸ªæ—¶å€™ä½ éƒ½æ€ä¹ˆå¤„ç†çš„ï¼Ÿ

ä½¿ç”¨ConcurrentHashMapï¼Œä»–çš„å¹¶å‘çš„ç›¸æ¯”å‰ä¸¤è€…å¥½å¾ˆå¤šã€‚

# ConcurrentHashMap

> å“¦ï¼Ÿé‚£ä½ è·Ÿæˆ‘è¯´è¯´ä»–çš„æ•°æ®ç»“æ„å§ï¼Œä»¥åŠä¸ºå•¥ä»–å¹¶å‘åº¦è¿™ä¹ˆé«˜ï¼Ÿ

ConcurrentHashMap åº•å±‚æ˜¯åŸºäº `æ•°ç»„ + é“¾è¡¨` ç»„æˆçš„ï¼Œä¸è¿‡åœ¨ jdk1.7 å’Œ 1.8 ä¸­å…·ä½“å®ç°ç¨æœ‰ä¸åŒã€‚

æˆ‘å…ˆè¯´ä¸€ä¸‹ä»–åœ¨1.7ä¸­çš„æ•°æ®ç»“æ„å§ï¼š

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f140880441eab3)

å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯ç”± Segment æ•°ç»„ã€HashEntry ç»„æˆï¼Œå’Œ HashMap ä¸€æ ·ï¼Œä»ç„¶æ˜¯**æ•°ç»„åŠ é“¾è¡¨**ã€‚

Segment æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸»è¦çš„ç»„æˆå¦‚ä¸‹ï¼š

```java
static final class Segment<K,V> extends ReentrantLock implements Serializable {

    private static final long serialVersionUID = 2249069246763182397L;

    // å’Œ HashMap ä¸­çš„ HashEntry ä½œç”¨ä¸€æ ·ï¼ŒçœŸæ­£å­˜æ”¾æ•°æ®çš„æ¡¶
    transient volatile HashEntry<K,V>[] table;

    transient int count;
        // è®°å¾—å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰ä¹ˆï¼Ÿ
    transient int modCount;
        // å¤§å°
    transient int threshold;
        // è´Ÿè½½å› å­
    final float loadFactor;

}
å¤åˆ¶ä»£ç 
```

HashEntryè·ŸHashMapå·®ä¸å¤šçš„ï¼Œä½†æ˜¯ä¸åŒç‚¹æ˜¯ï¼Œä»–ä½¿ç”¨volatileå»ä¿®é¥°äº†ä»–çš„æ•°æ®Valueè¿˜æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹nextã€‚

> volatileçš„ç‰¹æ€§æ˜¯å•¥ï¼Ÿ

- ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ï¼ˆå®ç°**å¯è§æ€§**ï¼‰
- ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚ï¼ˆå®ç°**æœ‰åºæ€§**ï¼‰
- volatile åªèƒ½ä¿è¯å¯¹å•æ¬¡è¯»/å†™çš„åŸå­æ€§ã€‚i++ è¿™ç§æ“ä½œä¸èƒ½ä¿è¯**åŸå­æ€§**ã€‚

æˆ‘å°±ä¸å¤§ç¯‡å¹…ä»‹ç»äº†ï¼Œå¤šçº¿ç¨‹ç« èŠ‚æˆ‘ä¼šè¯´åˆ°çš„ï¼Œå¤§å®¶çŸ¥é“ç”¨äº†ä¹‹åå®‰å…¨äº†å°±å¯¹äº†ã€‚

> é‚£ä½ èƒ½è¯´è¯´ä»–å¹¶å‘åº¦é«˜çš„åŸå› ä¹ˆï¼Ÿ

åŸç†ä¸Šæ¥è¯´ï¼ŒConcurrentHashMap é‡‡ç”¨äº†**åˆ†æ®µé”**æŠ€æœ¯ï¼Œå…¶ä¸­ Segment ç»§æ‰¿äº ReentrantLockã€‚

ä¸ä¼šåƒ HashTable é‚£æ ·ä¸ç®¡æ˜¯ put è¿˜æ˜¯ get æ“ä½œéƒ½éœ€è¦åšåŒæ­¥å¤„ç†ï¼Œç†è®ºä¸Š ConcurrentHashMap æ”¯æŒ CurrencyLevel (Segment æ•°ç»„æ•°é‡)çš„çº¿ç¨‹å¹¶å‘ã€‚

æ¯å½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®ä¸€ä¸ª Segment æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segmentã€‚

å°±æ˜¯è¯´å¦‚æœå®¹é‡å¤§å°æ˜¯16ä»–çš„å¹¶å‘åº¦å°±æ˜¯16ï¼Œå¯ä»¥åŒæ—¶å…è®¸16ä¸ªçº¿ç¨‹æ“ä½œ16ä¸ªSegmentè€Œä¸”è¿˜æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

```java
public V put(K key, V value) {
    Segment<K,V> s;
    if (value == null)
        throw new NullPointerException();//è¿™å°±æ˜¯ä¸ºå•¥ä»–ä¸å¯ä»¥put nullå€¼çš„åŸå› 
    int hash = hash(key);
    int j = (hash >>> segmentShift) & segmentMask;
    if ((s = (Segment<K,V>)UNSAFE.getObject          
         (segments, (j << SSHIFT) + SBASE)) == null) 
        s = ensureSegment(j);
    return s.put(key, hash, value, false);
}
å¤åˆ¶ä»£ç 
```

ä»–å…ˆå®šä½åˆ°Segmentï¼Œç„¶åå†è¿›è¡Œputæ“ä½œã€‚

æˆ‘ä»¬çœ‹çœ‹ä»–çš„putæºä»£ç ï¼Œä½ å°±çŸ¥é“ä»–æ˜¯æ€ä¹ˆåšåˆ°çº¿ç¨‹å®‰å…¨çš„äº†ï¼Œå…³é”®å¥å­æˆ‘æ³¨é‡Šäº†ã€‚

```java
        final V put(K key, int hash, V value, boolean onlyIfAbsent) {
          // å°†å½“å‰ Segment ä¸­çš„ table é€šè¿‡ key çš„ hashcode å®šä½åˆ° HashEntry
            HashEntry<K,V> node = tryLock() ? null :
                scanAndLockForPut(key, hash, value);
            V oldValue;
            try {
                HashEntry<K,V>[] tab = table;
                int index = (tab.length - 1) & hash;
                HashEntry<K,V> first = entryAt(tab, index);
                for (HashEntry<K,V> e = first;;) {
                    if (e != null) {
                        K k;
 // éå†è¯¥ HashEntryï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åˆ¤æ–­ä¼ å…¥çš„ key å’Œå½“å‰éå†çš„ key æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è¦†ç›–æ—§çš„ valueã€‚
                        if ((k = e.key) == key ||
                            (e.hash == hash && key.equals(k))) {
                            oldValue = e.value;
                            if (!onlyIfAbsent) {
                                e.value = value;
                                ++modCount;
                            }
                            break;
                        }
                        e = e.next;
                    }
                    else {
                 // ä¸ä¸ºç©ºåˆ™éœ€è¦æ–°å»ºä¸€ä¸ª HashEntry å¹¶åŠ å…¥åˆ° Segment ä¸­ï¼ŒåŒæ—¶ä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚
                        if (node != null)
                            node.setNext(first);
                        else
                            node = new HashEntry<K,V>(hash, key, value, first);
                        int c = count + 1;
                        if (c > threshold && tab.length < MAXIMUM_CAPACITY)
                            rehash(node);
                        else
                            setEntryAt(tab, index, node);
                        ++modCount;
                        count = c;
                        oldValue = null;
                        break;
                    }
                }
            } finally {
               //é‡Šæ”¾é”
                unlock();
            }
            return oldValue;
        }
```

é¦–å…ˆç¬¬ä¸€æ­¥çš„æ—¶å€™ä¼šå°è¯•è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥è‚¯å®šå°±æœ‰å…¶ä»–çº¿ç¨‹å­˜åœ¨ç«äº‰ï¼Œåˆ™åˆ©ç”¨ `scanAndLockForPut()` è‡ªæ—‹è·å–é”ã€‚

1. å°è¯•è‡ªæ—‹è·å–é”ã€‚
2. å¦‚æœé‡è¯•çš„æ¬¡æ•°è¾¾åˆ°äº† `MAX_SCAN_RETRIES` åˆ™æ”¹ä¸ºé˜»å¡é”è·å–ï¼Œä¿è¯èƒ½è·å–æˆåŠŸã€‚

> é‚£ä»–getçš„é€»è¾‘å‘¢ï¼Ÿ

get é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°† Key é€šè¿‡ Hash ä¹‹åå®šä½åˆ°å…·ä½“çš„ Segment ï¼Œå†é€šè¿‡ä¸€æ¬¡ Hash å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Šã€‚

ç”±äº HashEntry ä¸­çš„ value å±æ€§æ˜¯ç”¨ volatile å…³é”®è¯ä¿®é¥°çš„ï¼Œä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–æ—¶éƒ½æ˜¯æœ€æ–°å€¼ã€‚

ConcurrentHashMap çš„ get æ–¹æ³•æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œ**å› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦åŠ é”**ã€‚

> ä½ æœ‰æ²¡æœ‰å‘ç°1.7è™½ç„¶å¯ä»¥æ”¯æŒæ¯ä¸ªSegmentå¹¶å‘è®¿é—®ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Ÿ

æ˜¯çš„ï¼Œå› ä¸ºåŸºæœ¬ä¸Šè¿˜æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¿˜å¾—éå†é“¾è¡¨ï¼Œä¼šå¯¼è‡´æ•ˆç‡å¾ˆä½ï¼Œè¿™ä¸ªè·Ÿjdk1.7çš„HashMapæ˜¯å­˜åœ¨çš„ä¸€æ ·é—®é¢˜ï¼Œæ‰€ä»¥ä»–åœ¨jdk1.8å®Œå…¨ä¼˜åŒ–äº†ã€‚

> é‚£ä½ å†è·Ÿæˆ‘èŠèŠjdk1.8ä»–çš„æ•°æ®ç»“æ„æ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

å…¶ä¸­æŠ›å¼ƒäº†åŸæœ‰çš„ Segment åˆ†æ®µé”ï¼Œè€Œé‡‡ç”¨äº† `CAS + synchronized` æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ã€‚

è·ŸHashMapå¾ˆåƒï¼Œä¹ŸæŠŠä¹‹å‰çš„HashEntryæ”¹æˆäº†Nodeï¼Œä½†æ˜¯ä½œç”¨ä¸å˜ï¼ŒæŠŠå€¼å’Œnexté‡‡ç”¨äº†volatileå»ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œå¹¶ä¸”ä¹Ÿå¼•å…¥äº†çº¢é»‘æ ‘ï¼Œåœ¨é“¾è¡¨å¤§äºä¸€å®šå€¼çš„æ—¶å€™ä¼šè½¬æ¢ï¼ˆé»˜è®¤æ˜¯8ï¼‰ã€‚

> åŒæ ·çš„ï¼Œä½ èƒ½è·Ÿæˆ‘èŠä¸€ä¸‹ä»–å€¼çš„å­˜å–æ“ä½œä¹ˆï¼Ÿä»¥åŠæ˜¯æ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ

ConcurrentHashMapåœ¨è¿›è¡Œputæ“ä½œçš„è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

1. æ ¹æ® key è®¡ç®—å‡º hashcode ã€‚
2. åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œåˆå§‹åŒ–ã€‚
3. å³ä¸ºå½“å‰ key å®šä½å‡ºçš„ Nodeï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®ï¼Œåˆ©ç”¨ CAS å°è¯•å†™å…¥ï¼Œå¤±è´¥åˆ™è‡ªæ—‹ä¿è¯æˆåŠŸã€‚
4. å¦‚æœå½“å‰ä½ç½®çš„ `hashcode == MOVED == -1`,åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚
5. å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™åˆ©ç”¨ synchronized é”å†™å…¥æ•°æ®ã€‚
6. å¦‚æœæ•°é‡å¤§äº `TREEIFY_THRESHOLD` åˆ™è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f140880b600d11)

> ä½ åœ¨ä¸Šé¢æåˆ°CASæ˜¯ä»€ä¹ˆï¼Ÿè‡ªæ—‹åˆæ˜¯ä»€ä¹ˆï¼Ÿ

CAS æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæ˜¯ä¸€ç§è½»é‡çº§é”ï¼ŒJUC ä¸­å¾ˆå¤šå·¥å…·ç±»çš„å®ç°å°±æ˜¯åŸºäº CAS çš„ã€‚

CAS æ“ä½œçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹åœ¨è¯»å–æ•°æ®æ—¶ä¸è¿›è¡ŒåŠ é”ï¼Œåœ¨å‡†å¤‡å†™å›æ•°æ®æ—¶ï¼Œæ¯”è¾ƒåŸå€¼æ˜¯å¦ä¿®æ”¹ï¼Œè‹¥æœªè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹åˆ™å†™å›ï¼Œè‹¥å·²è¢«ä¿®æ”¹ï¼Œåˆ™é‡æ–°æ‰§è¡Œè¯»å–æµç¨‹ã€‚

è¿™æ˜¯ä¸€ç§ä¹è§‚ç­–ç•¥ï¼Œè®¤ä¸ºå¹¶å‘æ“ä½œå¹¶ä¸æ€»ä¼šå‘ç”Ÿã€‚

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f1408812043a58)

è¿˜æ˜¯ä¸æ˜ç™½ï¼Ÿé‚£æˆ‘å†è¯´æ˜ä¸‹ï¼Œä¹è§‚é”åœ¨å®é™…å¼€å‘åœºæ™¯ä¸­éå¸¸å¸¸è§ï¼Œå¤§å®¶è¿˜æ˜¯è¦å»ç†è§£ã€‚

å°±æ¯”å¦‚æˆ‘ç°åœ¨è¦ä¿®æ”¹æ•°æ®åº“çš„ä¸€æ¡æ•°æ®ï¼Œä¿®æ”¹ä¹‹å‰æˆ‘å…ˆæ‹¿åˆ°ä»–åŸæ¥çš„å€¼ï¼Œç„¶ååœ¨SQLé‡Œé¢è¿˜ä¼šåŠ ä¸ªåˆ¤æ–­ï¼ŒåŸæ¥çš„å€¼å’Œæˆ‘æ‰‹ä¸Šæ‹¿åˆ°çš„ä»–çš„åŸæ¥çš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·æˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹äº†ï¼Œä¸ä¸€æ ·å°±è¯æ˜è¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹äº†ä½ å°±returné”™è¯¯å°±å¥½äº†ã€‚

SQLä¼ªä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼š

```sql
update a set value = newValue where value = #{oldValue}//oldValueå°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå‰æŸ¥è¯¢å‡ºæ¥çš„å€¼ 
```

> CASå°±ä¸€å®šèƒ½ä¿è¯æ•°æ®æ²¡è¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹è¿‡ä¹ˆï¼Ÿ

å¹¶ä¸æ˜¯çš„ï¼Œæ¯”å¦‚å¾ˆç»å…¸çš„ABAé—®é¢˜ï¼ŒCASå°±æ— æ³•åˆ¤æ–­äº†ã€‚

> ä»€ä¹ˆæ˜¯ABAï¼Ÿ

å°±æ˜¯è¯´æ¥äº†ä¸€ä¸ªçº¿ç¨‹æŠŠå€¼æ”¹å›äº†Bï¼Œåˆæ¥äº†ä¸€ä¸ªçº¿ç¨‹æŠŠå€¼åˆæ”¹å›äº†Aï¼Œå¯¹äºè¿™ä¸ªæ—¶å€™åˆ¤æ–­çš„çº¿ç¨‹ï¼Œå°±å‘ç°ä»–çš„å€¼è¿˜æ˜¯Aï¼Œæ‰€ä»¥ä»–å°±ä¸çŸ¥é“è¿™ä¸ªå€¼åˆ°åº•æœ‰æ²¡æœ‰è¢«äººæ”¹è¿‡ï¼Œå…¶å®å¾ˆå¤šåœºæ™¯å¦‚æœåªè¿½æ±‚æœ€åç»“æœæ­£ç¡®ï¼Œè¿™æ˜¯æ²¡å…³ç³»çš„ã€‚

ä½†æ˜¯å®é™…è¿‡ç¨‹ä¸­è¿˜æ˜¯éœ€è¦è®°å½•ä¿®æ”¹è¿‡ç¨‹çš„ï¼Œæ¯”å¦‚èµ„é‡‘ä¿®æ”¹ä»€ä¹ˆçš„ï¼Œä½ æ¯æ¬¡ä¿®æ”¹çš„éƒ½åº”è¯¥æœ‰è®°å½•ï¼Œæ–¹ä¾¿å›æº¯ã€‚

> é‚£æ€ä¹ˆè§£å†³ABAé—®é¢˜ï¼Ÿ

ç”¨ç‰ˆæœ¬å·å»ä¿è¯å°±å¥½äº†ï¼Œå°±æ¯”å¦‚è¯´ï¼Œæˆ‘åœ¨ä¿®æ”¹å‰å»æŸ¥è¯¢ä»–åŸæ¥çš„å€¼çš„æ—¶å€™å†å¸¦ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡åˆ¤æ–­å°±è¿å€¼å’Œç‰ˆæœ¬å·ä¸€èµ·åˆ¤æ–­ï¼Œåˆ¤æ–­æˆåŠŸå°±ç»™ç‰ˆæœ¬å·åŠ 1ã€‚

```sql
update a set value = newValue ï¼Œvision = vision + 1 where value = #{oldValue} and vision = #{vision} // åˆ¤æ–­åŸæ¥çš„å€¼å’Œç‰ˆæœ¬å·æ˜¯å¦åŒ¹é…ï¼Œä¸­é—´æœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹ï¼Œå€¼å¯èƒ½ç›¸ç­‰ï¼Œä½†æ˜¯ç‰ˆæœ¬å·100%ä¸ä¸€æ ·
å¤åˆ¶ä»£ç 
```

> é™¤äº†ç‰ˆæœ¬å·è¿˜æœ‰åˆ«çš„æ–¹æ³•ä¿è¯ä¹ˆï¼Ÿ

å…¶å®æœ‰å¾ˆå¤šæ–¹å¼ï¼Œæ¯”å¦‚æ—¶é—´æˆ³ä¹Ÿå¯ä»¥ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æŠŠæ—¶é—´æˆ³ä¸€èµ·æŸ¥å‡ºæ¥ï¼Œå¯¹çš„ä¸Šæ‰ä¿®æ”¹å¹¶ä¸”æ›´æ–°å€¼çš„æ—¶å€™ä¸€èµ·ä¿®æ”¹æ›´æ–°æ—¶é—´ï¼Œè¿™æ ·ä¹Ÿèƒ½ä¿è¯ï¼Œæ–¹æ³•å¾ˆå¤šä½†æ˜¯è·Ÿç‰ˆæœ¬å·éƒ½æ˜¯å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œçœ‹åœºæ™¯å¤§å®¶æƒ³æ€ä¹ˆè®¾è®¡å§ã€‚

> CASæ€§èƒ½å¾ˆé«˜ï¼Œä½†æ˜¯æˆ‘çŸ¥é“synchronizedæ€§èƒ½å¯ä¸å’‹åœ°ï¼Œä¸ºå•¥jdk1.8å‡çº§ä¹‹ååè€Œå¤šäº†synchronizedï¼Ÿ

synchronizedä¹‹å‰ä¸€ç›´éƒ½æ˜¯é‡é‡çº§çš„é”ï¼Œä½†æ˜¯åæ¥javaå®˜æ–¹æ˜¯å¯¹ä»–è¿›è¡Œè¿‡å‡çº§çš„ï¼Œä»–ç°åœ¨é‡‡ç”¨çš„æ˜¯é”å‡çº§çš„æ–¹å¼å»åšçš„ã€‚

é’ˆå¯¹ synchronized è·å–é”çš„æ–¹å¼ï¼ŒJVM ä½¿ç”¨äº†é”å‡çº§çš„ä¼˜åŒ–æ–¹å¼ï¼Œå°±æ˜¯å…ˆä½¿ç”¨**åå‘é”**ä¼˜å…ˆåŒä¸€çº¿ç¨‹ç„¶åå†æ¬¡è·å–é”ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±å‡çº§ä¸º **CAS è½»é‡çº§é”**ï¼Œå¦‚æœå¤±è´¥å°±ä¼šçŸ­æš‚**è‡ªæ—‹**ï¼Œé˜²æ­¢çº¿ç¨‹è¢«ç³»ç»ŸæŒ‚èµ·ã€‚æœ€åå¦‚æœä»¥ä¸Šéƒ½å¤±è´¥å°±å‡çº§ä¸º**é‡é‡çº§é”**ã€‚

æ‰€ä»¥æ˜¯ä¸€æ­¥æ­¥å‡çº§ä¸Šå»çš„ï¼Œæœ€åˆä¹Ÿæ˜¯é€šè¿‡å¾ˆå¤šè½»é‡çº§çš„æ–¹å¼é”å®šçš„ã€‚

> ğŸ‚ï¼Œé‚£æˆ‘ä»¬å›å½’æ­£é¢˜ï¼ŒConcurrentHashMapçš„getæ“ä½œåˆæ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

- æ ¹æ®è®¡ç®—å‡ºæ¥çš„ hashcode å¯»å€ï¼Œå¦‚æœå°±åœ¨æ¡¶ä¸Šé‚£ä¹ˆç›´æ¥è¿”å›å€¼ã€‚
- å¦‚æœæ˜¯çº¢é»‘æ ‘é‚£å°±æŒ‰ç…§æ ‘çš„æ–¹å¼è·å–å€¼ã€‚
- å°±ä¸æ»¡è¶³é‚£å°±æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼éå†è·å–å€¼ã€‚

![img](https://raw.githubusercontent.com/zicair/MyBlog/master/picbed/ConcurrentHashMap-Hashtable/16f14088244abb23)

å°ç»“ï¼š1.8 åœ¨ 1.7 çš„æ•°æ®ç»“æ„ä¸Šåšäº†å¤§çš„æ”¹åŠ¨ï¼Œé‡‡ç”¨çº¢é»‘æ ‘ä¹‹åå¯ä»¥ä¿è¯æŸ¥è¯¢æ•ˆç‡ï¼ˆ`O(logn)`ï¼‰ï¼Œç”šè‡³å–æ¶ˆäº† ReentrantLock æ”¹ä¸ºäº† synchronizedï¼Œè¿™æ ·å¯ä»¥çœ‹å‡ºåœ¨æ–°ç‰ˆçš„ JDK ä¸­å¯¹ synchronized ä¼˜åŒ–æ˜¯å¾ˆåˆ°ä½çš„ã€‚

# fail-fast & fail-safe

ä¸€ï¼šå¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰

â€‹     åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡ºConcurrent Modification Exceptionã€‚

â€‹     åŸç†ï¼šè¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª modCount å˜é‡ã€‚é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜modCountçš„å€¼ã€‚æ¯å½“è¿­ä»£å™¨ä½¿ç”¨hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹modCountå˜é‡æ˜¯å¦ä¸ºexpectedmodCountå€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚

   æ³¨æ„ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹modCountå€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº†expectedmodCountå€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„bugã€‚

   åœºæ™¯ï¼šjava.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼ˆè¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼‰ã€‚

  äºŒï¼šå®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰

   é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨éå†æ—¶ä¸æ˜¯ç›´æ¥åœ¨é›†åˆå†…å®¹ä¸Šè®¿é—®çš„ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶åŸæœ‰é›†åˆå†…å®¹ï¼Œåœ¨æ‹·è´çš„é›†åˆä¸Šè¿›è¡Œéå†ã€‚

   åŸç†ï¼šç”±äºè¿­ä»£æ—¶æ˜¯å¯¹åŸé›†åˆçš„æ‹·è´è¿›è¡Œéå†ï¼Œæ‰€ä»¥åœ¨éå†è¿‡ç¨‹ä¸­å¯¹åŸé›†åˆæ‰€ä½œçš„ä¿®æ”¹å¹¶ä¸èƒ½è¢«è¿­ä»£å™¨æ£€æµ‹åˆ°ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘Concurrent Modification Exceptionã€‚

   ç¼ºç‚¹ï¼šåŸºäºæ‹·è´å†…å®¹çš„ä¼˜ç‚¹æ˜¯é¿å…äº†Concurrent Modification Exceptionï¼Œä½†åŒæ ·åœ°ï¼Œè¿­ä»£å™¨å¹¶ä¸èƒ½è®¿é—®åˆ°ä¿®æ”¹åçš„å†…å®¹ï¼Œå³ï¼šè¿­ä»£å™¨éå†çš„æ˜¯å¼€å§‹éå†é‚£ä¸€åˆ»æ‹¿åˆ°çš„é›†åˆæ‹·è´ï¼Œåœ¨éå†æœŸé—´åŸé›†åˆå‘ç”Ÿçš„ä¿®æ”¹è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚

â€‹     åœºæ™¯ï¼šjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚

å¿«é€Ÿå¤±è´¥å’Œå®‰å…¨å¤±è´¥æ˜¯å¯¹è¿­ä»£å™¨è€Œè¨€çš„ã€‚ å¿«é€Ÿå¤±è´¥ï¼šå½“åœ¨è¿­ä»£ä¸€ä¸ªé›†åˆçš„æ—¶å€™ï¼Œå¦‚æœæœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹åœ¨ä¿®æ”¹è¿™ä¸ªé›†åˆï¼Œå°±ä¼šæŠ›å‡ºConcurrentModificationå¼‚å¸¸ï¼Œjava.utilä¸‹éƒ½æ˜¯å¿«é€Ÿå¤±è´¥ã€‚ å®‰å…¨å¤±è´¥ï¼šåœ¨è¿­ä»£æ—¶å€™ä¼šåœ¨é›†åˆäºŒå±‚åšä¸€ä¸ªæ‹·è´ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹é›†åˆä¸Šå±‚å…ƒç´ ä¸ä¼šå½±å“ä¸‹å±‚ã€‚åœ¨java.util.concurrentä¸‹éƒ½æ˜¯å®‰å…¨å¤±è´¥

# æ€»ç»“ 

Hashtable&ConcurrentHashMapè·ŸHashMapåŸºæœ¬ä¸Šå°±æ˜¯ä¸€å¥—**è¿ç¯ç»„åˆ**ï¼Œæˆ‘åœ¨é¢è¯•çš„æ—¶å€™ç»å¸¸èƒ½å¹ä¸Šå¾ˆä¹…ï¼Œç»å¸¸è¢«é¢è¯•å®˜è¯´ï¼šå¥½äº†å¥½äº†ï¼Œæˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªè¯é¢˜å§å“ˆå“ˆã€‚

æ˜¯çš„å› ä¸ºæåˆ°HashMapä½ è‚¯å®šä¼šèŠåˆ°ä»–çš„çº¿ç¨‹å®‰å…¨æ€§è¿™ä¸€ç‚¹ï¼Œé‚£ä½ æ€»ä¸èƒ½åŠ é”ä¸€å¥è¯å°±æå®šäº†å§ï¼Œjavaçš„ä½œè€…ä»¬ä¹Ÿä¸æƒ³ï¼Œæ‰€ä»¥äººå®¶å†™å¼€å‘äº†å¯¹åº”çš„æ›¿ä»£å“ï¼Œé‚£å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„Hashtable&ConcurrentHashMapã€‚

ä¸¤è€…éƒ½æœ‰ç‰¹ç‚¹ï¼Œä½†æ˜¯çº¿ç¨‹å®‰å…¨åœºæ™¯è¿˜æ˜¯**åè€…ç”¨å¾—å¤šä¸€ç‚¹**ï¼ŒåŸå› æˆ‘åœ¨æ–‡ä¸­å·²ç»å¤§ç¯‡å¹…å…¨æ–¹ä½çš„ä»‹ç»äº†ï¼Œè¿™é‡Œå°±ä¸å†è¿‡å¤šèµ˜è¿°äº†ã€‚

ä½ ä»¬å‘ç°äº†**é¢è¯•å°±æ˜¯ä¸€ä¸ªä¸ªçš„å‘**ï¼Œä½ è¯´åˆ°å•¥é¢è¯•å®˜å¯èƒ½å°±æ€¼åˆ°ä½ å•¥ï¼Œåˆ«é—®æˆ‘ä¸ºå•¥çŸ¥é“å˜¿å˜¿ã€‚

ä½ çŸ¥é“ä¸ç¡®å®šèƒ½ä¸èƒ½ä¸ºè¿™åœºé¢è¯•åŠ åˆ†ï¼Œä½†æ˜¯ä¸çŸ¥é“è‚¯å®šæ˜¯å‡åˆ†çš„ï¼Œæ–‡ä¸­çš„**å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰**é—®åˆ°ï¼Œé‚£å¯¹åº”çš„**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**ä¹Ÿæ˜¯æœ‰å¯èƒ½çŸ¥é“çš„ï¼Œæˆ‘æƒ³è¯»è€…å¾ˆå¤šéƒ½ä¸çŸ¥é“å§ï¼Œå› ä¸ºæˆ‘é—®è¿‡å¾ˆå¤šä»”å“ˆå“ˆã€‚

è¿˜æœ‰æåˆ°CASä¹è§‚é”ï¼Œä½ è¦çŸ¥é“ABAï¼Œä½ è¦çŸ¥é“è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºåœ¨å®é™…çš„å¼€å‘åœºæ™¯çœŸçš„ä¸è¦å¤ªå¸¸ç”¨äº†ï¼Œsyncçš„é”å‡çº§ä½ ä¹Ÿè¦çŸ¥é“ã€‚

æˆ‘æ²¡è¿‡å¤šæè¿°çº¿ç¨‹å®‰å…¨çš„å¤ªå¤šä¸œè¥¿ï¼Œå› ä¸ºæˆ‘éƒ½å†™äº†ï¼Œä»¥åæ›´å•¥ï¼Ÿå¯¹å§å“ˆå“ˆã€‚

# å¸¸è§é—®é¢˜ 

- è°ˆè°ˆä½ ç†è§£çš„ Hashtableï¼Œè®²è®²å…¶ä¸­çš„ get put è¿‡ç¨‹ã€‚ConcurrentHashMapåŒé—®ã€‚
- 1.8 åšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Ÿ
- çº¿ç¨‹å®‰å…¨æ€ä¹ˆåšçš„ï¼Ÿ
- ä¸å®‰å…¨ä¼šå¯¼è‡´å“ªäº›é—®é¢˜ï¼Ÿ
- å¦‚ä½•è§£å†³ï¼Ÿæœ‰æ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„å¹¶å‘å®¹å™¨ï¼Ÿ
- ConcurrentHashMap æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ 
- ConcurrentHashMapå¹¶å‘åº¦ä¸ºå•¥å¥½è¿™ä¹ˆå¤šï¼Ÿ
- 1.7ã€1.8 å®ç°æœ‰ä½•ä¸åŒï¼Ÿä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ
- CASæ˜¯å•¥ï¼Ÿ
- ABAæ˜¯å•¥ï¼Ÿåœºæ™¯æœ‰å“ªäº›ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ
- synchronizedåº•å±‚åŸç†æ˜¯å•¥ï¼Ÿ
- synchronizedé”å‡çº§ç­–ç•¥
- å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰æ˜¯å•¥ï¼Œåº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿå®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰åŒé—®ã€‚
- â€¦â€¦

# åŠ åˆ†é¡¹ 

åœ¨å›ç­”Hashtableå’ŒConcurrentHashMapç›¸å…³çš„é¢è¯•é¢˜çš„æ—¶å€™ï¼Œä¸€å®šè¦çŸ¥é“ä»–ä»¬æ˜¯æ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£çº¿ç¨‹ä¸å®‰å…¨ä¸€èˆ¬éƒ½æ˜¯å‘ç”Ÿåœ¨å­˜å–çš„è¿‡ç¨‹ä¸­çš„ï¼Œé‚£getã€putä½ è‚¯å®šè¦çŸ¥é“ã€‚

HashMapæ˜¯å¿…é—®çš„é‚£ç§ï¼Œè¿™ä¸¤ä¸ªç»å¸¸ä¼šä½œä¸ºæ›¿è¡¥é—®é¢˜ï¼Œä¸è¿‡ä¹Ÿç»å¸¸é—®ï¼Œä»–ä»¬æœ¬èº«çš„æœºåˆ¶å…¶å®éƒ½æ¯”è¾ƒç®€å•ï¼Œç‰¹åˆ«æ˜¯ConcurrentHashMapè·ŸHashMapæ˜¯å¾ˆåƒçš„ï¼Œåªæ˜¯æ˜¯å¦çº¿ç¨‹å®‰å…¨è¿™ç‚¹ä¸åŒã€‚

æåˆ°çº¿ç¨‹å®‰å…¨é‚£ä½ å°±è¦çŸ¥é“ç›¸å…³çš„çŸ¥è¯†ç‚¹äº†ï¼Œæ¯”å¦‚è¯´åˆ°CASä½ ä¸€å®šè¦çŸ¥é“ABAçš„é—®é¢˜ï¼Œæåˆ°synchronizedé‚£ä½ è¦çŸ¥é“ä»–çš„åŸç†ï¼Œä»–é”å¯¹è±¡ï¼Œæ–¹æ³•ã€ä»£ç å—ï¼Œåœ¨åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ã€‚

synchronizedä½ è¿˜éœ€è¦çŸ¥é“ä»–çš„é”å‡çº§æœºåˆ¶ï¼Œä»¥åŠä»–çš„å…„å¼ŸReentantLockï¼Œä¸¤è€…ä¸€ä¸ªæ˜¯jvmå±‚é¢çš„ä¸€ä¸ªæ˜¯jdkå±‚é¢çš„ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤§çš„åŒºåˆ«çš„ã€‚